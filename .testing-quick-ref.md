# Testing Quick Reference

## Run Commands

```bash
npm test                  # Run all tests once
npm run test:watch        # Watch mode - re-runs on file changes
npm run test:coverage     # Generate coverage report

# Run specific file
npx jest server.test.js

# Run specific test by name
npx jest -t "should create a new rating"

# Run with more detail
npx jest --verbose

# Run in band (no parallel - useful for debugging)
npx jest --runInBand
```

## Common Test Patterns

### Backend API Test
```javascript
test('should do something', async () => {
  const response = await request(app)
    .post('/api/endpoint')
    .send({ data: 'value' })
    .expect(200);

  expect(response.body).toMatchObject({
    expected: 'shape'
  });
});
```

### Frontend Pure Function Test
```javascript
test('should transform input', () => {
  const result = myFunction(input);
  expect(result).toBe(expected);
});
```

### Async Test with Callback
```javascript
test('should handle async', (done) => {
  doSomethingAsync((result) => {
    expect(result).toBeTruthy();
    done();
  });
});
```

### Mock localStorage
```javascript
const mockStorage = {
  data: {},
  getItem(key) { return this.data[key] || null; },
  setItem(key, value) { this.data[key] = value; }
};
```

## Jest Matchers

```javascript
// Equality
expect(value).toBe(5)                    // Strict equality (===)
expect(value).toEqual({ a: 1 })          // Deep equality
expect(value).not.toBe(5)                // Negation

// Truthiness
expect(value).toBeTruthy()               // != null/undefined/false/0/""
expect(value).toBeFalsy()                // == null/undefined/false/0/""
expect(value).toBeNull()                 // === null
expect(value).toBeUndefined()            // === undefined
expect(value).toBeDefined()              // !== undefined

// Numbers
expect(value).toBeGreaterThan(3)
expect(value).toBeGreaterThanOrEqual(3)
expect(value).toBeLessThan(5)
expect(value).toBeCloseTo(0.3)           // Floating point

// Strings
expect(string).toMatch(/regex/)
expect(string).toContain('substring')

// Arrays/Iterables
expect(array).toContain(item)
expect(array).toHaveLength(3)

// Objects
expect(obj).toMatchObject({ a: 1 })      // Partial match
expect(obj).toHaveProperty('key')
expect(obj).toHaveProperty('key', value)

// Exceptions
expect(() => fn()).toThrow()
expect(() => fn()).toThrow(Error)
expect(() => fn()).toThrow('error message')
```

## Test Structure

```javascript
describe('Feature Name', () => {
  // Setup
  beforeAll(() => {
    // Runs once before all tests
  });

  afterAll(() => {
    // Runs once after all tests
  });

  beforeEach(() => {
    // Runs before each test
  });

  afterEach(() => {
    // Runs after each test
  });

  test('should do something', () => {
    // Arrange
    const input = 'test';

    // Act
    const result = doSomething(input);

    // Assert
    expect(result).toBe('expected');
  });

  describe('Nested Suite', () => {
    test('nested test', () => {
      // Tests can be nested
    });
  });
});
```

## Debugging Tests

### Console Output
```javascript
test('debug test', () => {
  console.log('Debug info:', value);  // Shows in test output
  expect(value).toBe(expected);
});
```

### Run Single Test
```javascript
test.only('just this test', () => {
  // Only this test will run
});
```

### Skip Test
```javascript
test.skip('skip this test', () => {
  // This test won't run
});
```

### Node.js Debugger
```bash
node --inspect-brk node_modules/.bin/jest --runInBand

# Then open chrome://inspect in Chrome
```

## Common Issues

### Test Timeout
```javascript
test('long test', async () => {
  // Test code
}, 10000); // Timeout in ms
```

### Async Not Resolving
- Make sure to `await` promises
- Make sure to call `done()` in callback tests
- Check for unhandled promise rejections

### Database Issues
- Check that beforeEach clears data
- Ensure tests don't interfere with each other
- Use in-memory database for speed

### Mock Issues
- Mocks must be defined before importing modules
- Use `jest.mock()` at top of file
- Clear mocks between tests if needed

## Radio Calico Specific

### Test New Rating Endpoint
```javascript
test('new rating test', async () => {
  const response = await request(app)
    .post('/api/ratings')
    .send({
      songId: 'base64songid',
      userId: 'testuser123',
      rating: 'up',
      artist: 'Artist Name',
      title: 'Song Title'
    })
    .expect(200);

  expect(response.body.message).toBe('Rating saved successfully');
});
```

### Test Rating Retrieval
```javascript
test('get ratings', async () => {
  const response = await request(app)
    .get('/api/ratings/songId123?userId=user456')
    .expect(200);

  expect(response.body).toEqual({
    thumbsUp: expect.any(Number),
    thumbsDown: expect.any(Number),
    userVote: null // or 'up' or 'down'
  });
});
```

### Test Frontend Utils
```javascript
const { generateSongId } = require('./public/radio-calico-utils');

test('song id', () => {
  const id = generateSongId('Artist', 'Song');
  expect(id).toBeTruthy();

  // Verify it's valid base64
  const decoded = Buffer.from(id, 'base64').toString();
  expect(decoded).toBe('Artist::Song');
});
```

## Coverage

```bash
# Generate coverage report
npm run test:coverage

# View HTML report (after running coverage)
open coverage/lcov-report/index.html  # macOS
start coverage/lcov-report/index.html # Windows
```

## CI/CD Integration

### GitHub Actions
```yaml
- name: Run tests
  run: npm test

- name: Upload coverage
  uses: codecov/codecov-action@v3
```

## Tips

1. **Write tests first** when fixing bugs (TDD for bugs)
2. **Keep tests simple** - one concept per test
3. **Use descriptive names** - test name should be the documentation
4. **Test behavior, not implementation** - don't test internal details
5. **Mock external dependencies** - network, time, random
6. **Keep tests fast** - under 3 seconds for full suite
7. **Test edge cases** - null, empty, very large, unicode
8. **Don't test frameworks** - trust Express, SQLite work correctly
9. **Use coverage as a guide** - not a target
10. **Refactor tests too** - DRY applies to test code

---

**Quick Start:** Run `npm test` to see all tests pass! ðŸš€
